function getForm(t,s){var e=$('<div class="mts-panel mts-panel-body"><div class="mts-row"><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Phone</label><input id="mts-run-phone" type="text" class="mts-form-control tool_phone_formater" value="'+(null==mts.run.customer.phone?"":mts.run.customer.phone)+'"></div></div><div class="mts-col-sm-6"><div id="run_datepicker" class="mts-form-group mts-form-group-default"><label>Date</label><input type="datetime-local" id="mts-run-date" class="mts-form-control" placeholder="jj/mm/aaaa HH:II" value="'+(null==mts.run.date?"":mts.run.date)+'"></div></div></div><div class="mts-row"><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Nom</label><input id="mts-run-lastname" type="text" class="mts-form-control" value="'+(null==mts.run.customer.firstname?"":mts.run.customer.firstname)+'"></div></div><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Prénom</label><input id="mts-run-firstname" type="text" class="mts-form-control" value="'+(null==mts.run.customer.lastname?"":mts.run.customer.lastname)+'"></div></div></div><div class="mts-row"><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Mail</label><input id="mts-run-mail" type="email" class="mts-form-control" value="'+(null==mts.run.customer.mail?"":mts.run.customer.mail)+'"></div></div></div><div class="mts-row mts-m-t-10" id="mts-run-address-forms"></div><div class="mts-row mts-step-validate"><div class="mts-col-sm-12 mts-m-t-20"><button id="mts-step-add" class="mts-btn mts-btn-success">Ajouter une Adresse</button></div></div><div class="mts-row mts-m-t-20"><div class="mts-col-sm-4 mts-col-sm-offset-4"><hr></div></div><div class="mts-pricer"><div class="mts-row mts-m-t-40 mts-m-b-20"><div class="mts-col-sm-2 mts-col-sm-offset-5"><button id="mts-run-pricing" class="mts-btn mts-btn-info">Pricing</button></div></div><div class="mts-row"><div class="mts-col-sm-4 mts-m-t-20"><div class="mts-prices"><h4>Trottoir à Trottoir</h4><p id="mts-price-tt">'+(null!=mts.run.priceTT?mts.run.priceTT:"0")+'€</p></div></div><div class="mts-col-sm-4 mts-m-t-20"><div class="mts-prices"><h4>Porte à porte (1T)</h4><p id="mts-price-pp1">'+(null!=mts.run.pricePP1?mts.run.pricePP1:"0")+'€</p></div></div><div class="mts-col-sm-4 mts-m-t-20"><div class="mts-prices"><h4>Porte à porte (2T)</h4><p id="mts-price-pp2">'+(null!=mts.run.pricePP2?mts.run.pricePP2:"0")+'€</p></div></div></div><div class="mts-row mts-m-b-20"><div class="mts-col-sm-4 mts-col-sm-offset-4 mts-m-t-20"><div class="mts-form-group mts-form-group-default"><label>Supplément</label><input style="color: #000" id="mts-run-sup" type="number" class="mts-form-control"></div></div></div></div><div class="mts-row mts-m-b-20"><div class="mts-col-sm-4 mts-col-sm-offset-4"><hr></div></div><div class="mts-row mts-m-b-10"><div class="mts-col-sm-6"><select id="mts-run-flat-rate" class="mts-step-flat-rate mts-select"><option value="-1">Choisir un Forfait</option><option value="0">Trottoir à trottoir</option><option value="1">Porte à Porte (1 trooper)</option><option value="2">Porte à Porte (2 trooper)</option></select></div><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Prix TTC</label><input id="mts-run-ttc" type="text" class="mts-form-control" disabled></div></div></div><div class="mts-row mts-m-t-50"><div class="mts-col-sm-12"><div class="mts-row"><div class="mts-col-sm-4 mts-col-sm-offset-4"><button id="mts-run-validate" class="mts-btn mts-btn-success">Valider</button></div></div></div></div></div>');t.html(e),e.find(".tool_phone_formater").keyup(function(){$(this).val(phoneFormater($(this).val()))});for(var n in mts.run.steps)generateAddress(n);for(var n in mts.run.stuffs)addStuff($($(".mts-take-stuff").get(mts.run.stuffs[n].step)),!1,mts.run.stuffs[n]),didChangeDepositStuff($($(".select-2-stuff-deposit").get(mts.run.stuffs[n].step-1)),mts.run.stuffs[n],!0);e.find("#mts-run-phone").change(function(){mts.run.customer.phone=$(this).val(),""!=mts.run.customer.phone&&mts.run.getCustomer(function(t){mts.run.customer.id>0&&mts.run.fillCustomer()})}),e.find("#mts-run-lastname").change(function(){mts.run.customer.lastname=$(this).val()}),e.find("#mts-run-firstname").change(function(){mts.run.customer.firstname=$(this).val()}),e.find("#mts-run-mail").change(function(){mts.run.customer.mail=$(this).val()}),e.find("#mts-run-date").change(function(){mts.run.date=$(this).val()}),e.find("#mts-step-add").click(function(){mts.run.steps.length>0&&(null==mts.run.steps[mts.run.steps.length-1].address||""==mts.run.steps[mts.run.steps.length-1].address)||mts.run.addStep(null,0,0,null,null,!0)}),e.find("#mts-run-pricing").click(function(){mts.run.price()}),e.find("#mts-run-sup").change(function(){mts.run.supplement=parseFloat($(this).val()),mts.run.updateTTC(e.find("#mts-run-ttc"))}),e.find("#mts-run-flat-rate").change(function(){mts.run.flatRate=$(this).val(),mts.run.updateTTC(e.find("#mts-run-ttc"))}),e.find("#mts-run-validate").click(function(){mts.run.create(function(t){t.id&&s&&s(t)})})}function generateAddress(t){function s(s){return"undefined"!=typeof mts.run.steps[t]&&null!=mts.run.steps[t][s]?mts.run.steps[t][s]:""}var e=$('<div class="mts-col-sm-12 mts-m-t-20"><div class="mts-panel mts-panel-default"><div class="mts-panel-heading"><div class="mts-panel-title">Adresse #'+(parseInt(t)+1)+'</div></div><div class="mts-panel-body"><div class="mts-run-step mts-run-step-0"><div class="mts-row"><div class="mts-col-sm-12"><div class="mts-form-group mts-form-group-default"><label>Adresse</label><input type="text" class="mts-form-control mts-step-address" value="'+s("address")+'"></div></div></div><div class="mts-row"><div class="mts-col-sm-6"><select class="mts-step-floors mts-select"><option value="-1"'+(-1==s("floors")?" selected":"")+'>Trottoir</option><option value="0"'+(0==s("floors")?" selected":"")+'>RDC</option><option value="1"'+(1==s("floors")?" selected":"")+'>1er</option><option value="2"'+(2==s("floors")?" selected":"")+'>2nd</option><option value="3"'+(3==s("floors")?" selected":"")+'>3e</option><option value="4"'+(4==s("floors")?" selected":"")+'>4e</option><option value="5"'+(5==s("floors")?" selected":"")+'>5e</option><option value="6"'+(6==s("floors")?" selected":"")+'>6e</option><option value="7"'+(7==s("floors")?" selected":"")+'>7e</option><option value="8"'+(8==s("floors")?" selected":"")+'>8e</option><option value="9"'+(9==s("floors")?" selected":"")+'>9e</option><option value="10"'+(10==s("floors")?" selected":"")+'>10 et +</option></select></div><div class="mts-col-sm-6"><select class="mts-step-elevator mts-select"><option value="0"'+(0==s("elevator")?" selected":"")+'>Pas d\'ascenceur</option><option value="1"'+(1==s("elevator")?" selected":"")+'>Ascenceur 2p</option><option value="2"'+(2==s("elevator")?" selected":"")+'>Ascenceur 5p</option><option value="3"'+(3==s("elevator")?" selected":"")+'>Ascenceur 8p</option></select></div></div><div class="mts-row mts-m-t-10"><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Name</label><input type="text" class="mts-form-control mts-step-name" value="'+s("contactName")+'"></div></div><div class="mts-col-sm-6"><div class="mts-form-group mts-form-group-default"><label>Phone</label><input type="text" class="mts-form-control mts-step-phone" value="'+s("contactPhone")+'"></div></div></div><div class="mts-row mts-h-40"><div class="mts-col-sm-6"><input type="hidden" class="mts-take-stuff mts-select" />'+(t>0?'<input type="hidden" class="select-2-stuff-deposit mts-select" />':"")+(t>0?'<button class="mts-btn mts-btn-success empty-deposit">Vider</button>':"")+"</div>"+(t>0?'<div class="row mts-deposit-stuff"></div>':"")+'<div class="mts-col-sm-6"><button class="mts-btn mts-btn-success">Nouveau Stuff</button></div></div><div class="mts-row mts-stuff-form"></div></div></div></div></div>');$("#mts-run-address-forms").append(e),e.find(".mts-take-stuff").select2({placeholder:"Prendre un stuff",data:mts.stuff.getForSelect(mts.stuff.data)}),refreshDeposit(),e.find(".mts-take-stuff").change(function(){addStuff($(this)),refreshDeposit()}),e.find(".select-2-stuff-deposit").change(function(){didChangeDepositStuff($(this))}),e.find(".mts-step-floors").change(function(){var s=$(this);mts.run.steps[t].floors=s.val()}),e.find(".mts-step-elevator").change(function(){var s=$(this);mts.run.steps[t].elevator=s.val()}),e.find(".mts-step-name").change(function(){var s=$(this);mts.run.steps[t].contactName=s.val()}),e.find(".mts-step-phone").change(function(){var s=$(this);mts.run.steps[t].contactPhone=s.val()}),e.find(".empty-deposit").click(function(){for(breakLoopIn=0;mts.stuff.getNotDeposit(mts.run.stuffs).length!=breakLoopIn;)e.find(".select-2-stuff-deposit").first().val(mts.stuff.getNotDeposit(mts.run.stuffs)[breakLoopIn].id),e.find(".select-2-stuff-deposit").first().change()}),e.find(".mts-step-address").change(function(){element=$(this);var s=element.val();mts.address.search(s,function(s){if(s[0]){var e=s[0].formatted_address;element.val(e),mts.run.steps[t].address=e}})}),e.find(".mts-btn-success").click(function(){addStuff($(this),!0)})}function refreshDeposit(){var t=$(".select-2-stuff-deposit").select2();t.each(function(t,s){$(s).val(""),$(s).select2("destroy")}),$(".select-2-stuff-deposit").select2({placeholder:"Déposer un stuff",data:mts.stuff.getForSelect(mts.stuff.getNotDeposit(mts.run.stuffs),!0)})}function phoneFormater(t){return t="+"==t[0]?t.replace(/\+(\d{3})(\d{2})(\d{2})(\d{2})(\d{2})/,"+$1 $2 $3 $4 $5"):t.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1 $2 $3 $4 $5")}function addStuff(t,s,e){var n={id:"",name:"nouveau stuff",step:"",depositStep:[],volume:"",type:"normal",nb:1},r=t.parents().eq(5).first();n.step=r.index();var u=null;if(n.id=makeid(),1==s){var r=t.parents().eq(5).first();n.step=r.index(),u=$("<div class='mts-col-sm-10 mts-col-sm-offset-1 mts-m-t-10 border-bottom-1 mts-stuff-item'><div class='mts-row'><div class='mts-col-sm-2'><div class='mts-form-group mts-form-group-default'><input type='number' class='mts-form-control mts-stuff-nb' value='1'><input type='hidden' class='mts-form-control mts-stuff-id' value='"+n.id+"'></div></div><div class='mts-col-sm-3'><input type='text' class='mts-form-control mts-stuff-name' placeholder='nom' value='"+n.name+"'></div><div class='mts-col-sm-3'><input type='text' class='mts-form-control mts-stuff-category' placeholder='nom' value='"+n.type+"'></div><div class='mts-col-sm-2'><div class='mts-form-group mts-form-group-default'><input type='text' class='mts-form-control mts-stuff-dimension' placeholder='dimension'></div></div><div class='mts-col-sm-2'><button class='mts-btn mts-btn-error'>Suppr.</button></div></div></div>"),u.find(".mts-stuff-name").first().change(function(){n.name=$(this).val();for(var t=0;t<mts.run.stuffs.length;t++)mts.run.stuffs[t].id==n.id&&(mts.run.stuffs[t].name=$(this).val());var s=$(".deposit-stuff-item-"+n.id);s.each(function(t){$(this).find(".deposit-stuff-name").first().html(n.name)}),u.find(".mts-stuff-nb").first().change()}),u.find(".mts-stuff-category").first().select2({placeholder:"Catégorie",data:stuffCategories}),u.find(".mts-stuff-category").first().change(function(){for(var t=0;t<mts.run.stuffs.length;t++)mts.run.stuffs[t].id==n.id&&(mts.run.stuffs[t].type=$(this).val())})}else if(null==e){var o=t.val();n.name=o;for(var m in mts.stuff.data)mts.stuff.data[m].id==parseInt(o)&&(n.volume=mts.stuff.data[m].volume,n.type=mts.stuff.data[m].category,n.name=mts.stuff.data[m].name);u=$("<div class='mts-col-sm-10 mts-col-sm-offset-1 border-bottom-1 mts-stuff-item'><div class='row'><div class='mts-col-sm-2'><div class='mts-form-group mts-form-group-default'><input type='number' class='mts-form-control mts-stuff-nb' value='1'><input type='hidden' class='mts-form-control mts-stuff-id' value='"+n.id+"'></div></div><div class='mts-col-sm-4'><p style='display: inline-block;font-size: 16px;'>"+n.name+"</p></div><div class='mts-col-sm-3'><div class='mts-form-group mts-form-group-default'><input type='text' class='mts-form-control mts-stuff-dimension' placeholder='dimension' value='"+n.volume+"'></div></div><div class='mts-col-sm-3'><button class='mts-btn mts-btn-error'>Supprimer</button></div></div></div>")}else n=e,u=$("<div class='mts-col-sm-10 mts-col-sm-offset-1 border-bottom-1 mts-stuff-item'><div class='row'><div class='mts-col-sm-2'><div class='mts-form-group mts-form-group-default'><input type='number' class='mts-form-control mts-stuff-nb' value='"+n.nb+"'><input type='hidden' class='mts-form-control mts-stuff-id' value='"+n.id+"'></div></div><div class='mts-col-sm-4'><p style='display: inline-block;font-size: 16px;'>"+n.name+"</p></div><div class='mts-col-sm-3'><div class='mts-form-group mts-form-group-default'><input type='text' class='mts-form-control mts-stuff-dimension' placeholder='dimension' value='"+n.volume+"'></div></div><div class='mts-col-sm-3'><button class='mts-btn mts-btn-error'>Supprimer</button></div></div></div>");"undefined"!=typeof n.id&&null==e&&(stuffs.push({id:n.id,text:n.nb+" "+n.name}),mts.run.stuffs.push(n)),u.find(".mts-stuff-nb").first().change(function(){for(var t=$(this).parent().find(".mts-stuff-id").first().val(),s=null,e=0,n=0;n<mts.run.stuffs.length;n++)if(mts.run.stuffs[n].id==t){s=mts.run.stuffs[n],mts.run.stuffs[n].nb=parseInt($(this).val());for(var r=0;r<mts.run.stuffs[n].depositStep.length;r++)e+=mts.run.stuffs[n].depositStep[r].nb}if($(this).val()<e)return void $(this).val(e);if($(this).val()<0)return void $(this).val(0);for(var u=!1,n=0;n<stuffs.length;n++){var o=stuffs[n];o.id==t&&(o.text=s.nb-e+" "+s.name,stuffs[n]=o,u=!0)}u||"undefined"!=typeof s.id&&stuffs.push({id:s.id,text:s.nb-e+" "+s.name}),refreshDeposit()}),u.find(".mts-stuff-dimension").first().change(function(){for(var t=$(this).parents().eq(2).find(".mts-stuff-id").first().val(),s=0;s<mts.run.stuffs.length;s++)mts.run.stuffs[s].id==t&&(mts.run.stuffs[s].volume=$(this).val())}),u.find(".mts-btn").first().click(function(){for(var t=$(this).parents().eq(2).find(".mts-stuff-id").first().val(),s=0;s<stuffs.length;s++)stuffs[s].id==t&&stuffs.splice(s,1);refreshDeposit();for(var s=0;s<mts.run.stuffs.length;s++)mts.run.stuffs[s].id==t&&mts.run.stuffs.splice(s,1);return $(".deposit-stuff-item-"+t).remove(),$(this).parents().eq(2).remove(),!1}),refreshDeposit(),r.find(".mts-stuff-form").get(0).append(u[0])}function didChangeDepositStuff(t,s,e){if(!s){var n=t.val(),r=t.parents().eq(3).find(".mts-deposit-stuff").first().find(".deposit-stuff-item-"+n);if(r.length>0){var u=r.first().find(".deposit-stuff-nb").first(),o=parseInt(u.val());return u.val(o+1),void u.blur()}s={};for(var m=t.parents().eq(5).index(),a=0,i=0;i<mts.run.stuffs.length;i++)if(mts.run.stuffs[i].id==n){if(mts.run.stuffs[i].step==m)return void breakLoopIn++;mts.run.stuffs[i].depositStep.push({id:m,nb:1}),s=mts.run.stuffs[i];for(var f=0;f<mts.run.stuffs[i].depositStep.length;f++)a+=mts.run.stuffs[i].depositStep[f].nb}}var l=$("<span class='deposit-stuff-item deposit-stuff-item-"+s.id+"' stuff-id='"+s.id+"'><i class='mts-fa-times'>X</i><input class='deposit-stuff-nb' type='number' value='"+(null!=e?s.nb.toString():"1")+"'><span class='deposit-stuff-name'>"+s.name+"</span></span>");t.parents().eq(3).find(".mts-deposit-stuff").first().append(l),refreshDeposit(),l.find(".deposit-stuff-nb").first().blur(function(){updateDepositStuffNb($(this),s.id),refreshDeposit()}),l.find("i").first().click(function(){removeDepositStuffItem($(this),m)})}function updateDepositStuffNb(t,s){for(var e=t.parents().eq(6).index(),n={},r=0;r<mts.run.stuffs.length;r++)mts.run.stuffs[r].id==s&&(n=mts.run.stuffs[r]);var u=parseInt(t.val()),o=0,m=0;if(1>u)return void t.val(1);if(u>n.nb)return void t.val(n.nb);for(var r=0;r<mts.run.stuffs.length;r++)if(mts.run.stuffs[r].id==s){m=r;for(var a=0;a<mts.run.stuffs[r].depositStep.length;a++)mts.run.stuffs[r].depositStep[a].id==e&&(mts.run.stuffs[r].depositStep[a].nb=u),o+=mts.run.stuffs[r].depositStep[a].nb;n=mts.run.stuffs[r]}refreshDeposit()}function removeDepositStuffItem(t,s){for(var e={},n=t.parents().first().attr("stuff-id"),r=0;r<mts.run.stuffs.length;r++)mts.run.stuffs[r].id==n&&(e=mts.run.stuffs[r]);for(var u=t.parent(),o=0,r=0;r<mts.run.stuffs.length;r++)if(mts.run.stuffs[r].id==n)for(var m=0;m<mts.run.stuffs[r].depositStep.length;m++)mts.run.stuffs[r].depositStep[m].id==s?mts.run.stuffs[r].depositStep.splice(m,1):o+=mts.run.stuffs[r].depositStep[m].nb;u.remove(),refreshDeposit()}function makeid(){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=0;5>e;e++)t+=s.charAt(Math.floor(Math.random()*s.length));return"new-"+t}function cleanStepsAndStuffs(){for(var t in mts.run.steps){var s=mts.run.steps[t];if(null==s.address||void 0==s.address||""==s.address){for(var e in mts.run.stuffs){var n=mts.run.stuffs[e];for(var r in n.depositStep){var u=n.depositStep[r];u.id==s.customId&&delete n.depositStep[r]}}delete mts.run.steps[t]}}}var breakLoopIn=0,stuffCategories=[{id:"cardboard",text:"cardboard"},{id:"normal",text:"normal"},{id:"heavy",text:"heavy"},{id:"super_heavy",text:"super_heavy"}];mts={hasForm:!1},mts.auth={token:null,addr:null,client_id:null,client_secret:null,username:null,password:null},mts.auth.init=function(t,s,e,n,r){r||(r=!1),r?mts.auth.addr="https://dev-mars.mytroopers.com":mts.auth.addr="https://mars.mytroopers.com",mts.auth.client_id=t,mts.auth.client_secret=s,mts.auth.username=e,mts.auth.password=n},mts.auth.connect=function(t){null==mts.auth.token?$.ajax({url:mts.auth.addr+"/oauth/v2/token",method:"GET",data:{client_id:mts.auth.client_id,client_secret:mts.auth.client_secret,username:mts.auth.username,password:mts.auth.password,grant_type:"password"}}).success(function(s){mts.auth.token=s.access_token,t(mts.auth.token)}):t(mts.auth.token)},mts.run={customer:{id:0,firstname:null,lastname:null,mail:null,phone:null},date:null,flatRate:-1,supplement:0,duration:null,kms:null,estimatedPice:null,reduction:null,priceTT:null,pricePP1:null,pricePP2:null,privateCommentary:null,publicCommentary:null,steps:[],stuffs:[],owner:null},mts.run.setDate=function(t){mts.run.date=t,mts.hasForm&&$("#mts-run-date").val(t)},mts.run.getCustomer=function(t){mts.auth.connect(function(s){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/customers",data:{access_token:s,firstname:mts.run.customer.firstname,lastname:mts.run.customer.lastname,mail:mts.run.customer.mail,phone:mts.run.customer.phone}}).success(function(s){s[0]&&(mts.run.customer=s[0]),t&&t(mts.run.customer)}).error(function(t){console.log("Customer error : "+t.responseJSON.message)})})},mts.run.setCustomer=function(t,s,e,n){mts.run.customer.firstname=t,mts.run.customer.lastname=s,mts.run.customer.phone=phoneFormater(e),mts.run.customer.mail=n,mts.hasForm&&mts.run.fillCustomer()},mts.run.fillCustomer=function(){$("#mts-run-phone").val(mts.run.customer.phone),$("#mts-run-mail").val(mts.run.customer.mail),$("#mts-run-firstname").val(mts.run.customer.firstname),$("#mts-run-lastname").val(mts.run.customer.lastname)},mts.run.price=function(t){mts.auth.connect(function(s){if(null==mts.run.owner)return alert("Propriétaire de la course non définie");cleanStepsAndStuffs();var e=[];for(var n in mts.run.steps){var r=mts.run.steps[n];e.push(r.address)}return e.length<2?alert("Il faut minimum 2 adresses pour calculer un prix"):void mts.address.calculate(e,function(e){var n=e.distance,r=e.time;if(0==mts.run.stuffs.length)return alert("Aucun objet à transporter");for(var u in mts.run.stuffs)if(0==mts.run.stuffs[u].depositStep.length)return alert("Tout les objets ne sont pas déposé");var o=0;for(var u in mts.run.stuffs){var m=mts.run.stuffs[u];for(var a in m.depositStep)o+=parseFloat(m.volume)*m.depositStep[a].nb}mts.run.getCarTypeRequest(o,function(e){var u=[];for(var o in mts.run.stuffs)for(var m in mts.run.stuffs[o].depositStep){var a=mts.run.stuffs[o],i=mts.run.getStepById(a.step),f=mts.run.getStepById(a.depositStep[m].id);a.startFloors=i.floors,a.startElevator=i.elevator,a.endFloors=f.floors,a.endElevator=f.elevator,a.nb=a.depositStep[m].nb,u.push(a)}$.ajax({method:"POST",url:mts.auth.addr+"/plugin/price?access_token="+s,data:{duration:r,kms:n,carTypeRequest:e,stuffs:u,owner:mts.run.owner}}).success(function(s){switch(mts.run.priceTT=parseFloat(s.tt),mts.run.pricePP1=parseFloat(s.pp1),mts.run.pricePP2=parseFloat(s.pp2),$("#mts-price-tt").html(mts.run.priceTT.toFixed(2)+"€"),$("#mts-price-pp1").html(mts.run.pricePP1.toFixed(2)+"€"),$("#mts-price-pp2").html(mts.run.pricePP2.toFixed(2)+"€"),$("#mts-run-flat-rate").val()){case 0:mts.run.priceTTC=mts.run.priceTT.toFixed(2),$("#mts-run-ttc").val(mts.run.priceTT.toFixed(2));break;case 1:mts.run.priceTTC=mts.run.pricePP1.toFixed(2),$("#mts-run-ttc").val(mts.run.pricePP1.toFixed(2));break;case 2:mts.run.priceTTC=mts.run.pricePP2.toFixed(2),$("#mts-run-ttc").val(mts.run.pricePP2.toFixed(2))}t&&t(s)}).error(function(t){console.log("Price error : "+t.responseJSON.message)})})})})},mts.run.getCarTypeRequest=function(t,s){mts.auth.connect(function(e){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/measurement",data:{access_token:e,measurement:t}}).success(function(t){mts.run.carTypeRequest=t,s&&s(t)}).error(function(t){console.log("Measurement error : "+t.responseJSON.message)})})},mts.run.create=function(t){mts.auth.connect(function(s){if(null==mts.run.owner)return alert("Propriétaire de la course non définie");if(null==mts.run.date||""==mts.run.date)return alert("Aucune date et heure définie");if(null==mts.run.customer.firstname||""==mts.run.customer.firstname||null==mts.run.customer.phone||""==mts.run.customer.phone||null==mts.run.customer.mail||""==mts.run.customer.mail)return alert("Certaine informations client sont manquantent");cleanStepsAndStuffs();var e=[];for(var n in mts.run.steps){var r=mts.run.steps[n];e.push(r.address)}if(e.length<2)return alert("Il faut minimum 2 adresses pour calculer un prix");if(0==mts.run.stuffs.length)return alert("Aucun objet à transporter");for(var n in mts.run.stuffs)if(0==mts.run.stuffs[n].depositStep.length)return alert("Tout les objets ne sont pas déposé");var u=[];for(var n in mts.run.stuffs)for(var o in mts.run.stuffs[n].depositStep){var m=mts.run.stuffs[n],a=mts.run.getStepById(m.step),i=mts.run.getStepById(m.depositStep[o].id);m.startFloors=a.floors,m.startElevator=a.elevator,m.endFloors=i.floors,m.endElevator=i.elevator,m.nb=m.depositStep[o].nb,u.push(m)}mts.run.stuffs=u,mts.run.price(function(e){$.ajax({method:"POST",url:mts.auth.addr+"/plugin/run?access_token="+s,data:JSON.parse(JSON.stringify(mts.run))}).success(function(s){t&&t(s)}).error(function(t){console.log("Run error : "+t.responseJSON.message)})})})},mts.run.addStep=function(t,s,e,n,r,u){if(null!=t||null!=u){var o=mts.run.steps.length,m={customId:o,address:t,stepOrder:o,contactName:"undefined"!=typeof n?n:"",contactPhone:"undefined"!=typeof r?r:"",floors:"undefined"!=typeof s?s:-1,elevator:"undefined"!=typeof e?e:0};mts.run.steps.push(m),mts.hasForm&&generateAddress(o),null!=t&&mts.address.search(t,function(t){mts.run.steps[o].address=t[0].formatted_address,mts.hasForm&&"undefined"!=typeof $(".mts-step-address").get(o)&&($(".mts-step-address").get(o).value=t[0].formatted_address)})}},mts.run.getStepById=function(t){for(var s in mts.run.steps)if(mts.run.steps[s].customId==t)return mts.run.steps[s]},mts.stuff={data:[]},mts.stuff.list=function(t){mts.auth.connect(function(s){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/stuffs",data:{access_token:s}}).success(function(s){mts.stuff.data=s,t&&t(mts.stuff.data)}).error(function(t){console.log("Stuff error : "+t.responseJSON.message)})})},mts.stuff["new"]=function(t,s,e){var n={};t?n=mts.stuff.data[t]:(n.volume=e.volume,n.type=e.category),n.nb=1,n.step=s,n.depositStep=[],n.startFloors=0,n.endFloors=0,n.startElevator=0,n.endElevator=0,n.type=n.category,mts.run.stuffs.push(n)},mts.run.addStuff=function(t,s,e,n,r,u){if(!(null==t||null==s||null==e||null==n||null==r||null==u||s>=mts.run.steps.length||e>=mts.run.steps.length||1>u)){"cardboard"!=r&&"normal"!=r&&"heavy"!=r&&"super_heavy"!=r&&(r="heavy");var o={id:makeid(),name:t,step:s,depositStep:[{id:e,nb:u}],volume:n,type:r,nb:u};mts.run.stuffs.push(o),mts.hasForm&&"undefined"!=typeof $(".mts-take-stuff").get(s)&&(addStuff($($(".mts-take-stuff").get(s)),!1,o),didChangeDepositStuff($($(".select-2-stuff-deposit").get(s-1)),o,!0))}},mts.run.addStuffs=function(t){for(var s in t){var e=t[s].name,n=t[s].step,r=t[s].depositStep,u=t[s].volume,o=t[s].type,m=t[s].nb;if(null!=e&&null!=n&&null!=r&&null!=u&&null!=o&&null!=m&&n<mts.run.steps.length&&r<mts.run.steps.length&&m>=1){"cardboard"!=o&&"normal"!=o&&"heavy"!=o&&"super_heavy"!=o&&(o="heavy");var a={id:makeid(),name:e,step:n,depositStep:[{id:r,nb:m}],volume:u,type:o,nb:m};mts.run.stuffs.push(a),mts.hasForm&&"undefined"!=typeof $(".mts-take-stuff").get(n)&&(addStuff($($(".mts-take-stuff").get(n)),!1,a),didChangeDepositStuff($($(".select-2-stuff-deposit").get(n-1)),a,!0))}}},mts.run.getStuffs=function(){var t=mts.run.stuffs,s=[];for(var e in t)for(var n in t[e].depositStep){var r={name:t[e].name,step:t[e].step,depositStep:t[e].depositStep[n].id,volume:t[e].volume,type:t[e].type,nb:t[e].depositStep[n].nb};s.push(r)}return s},mts.address={},mts.address.search=function(t,s){mts.auth.connect(function(e){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/address/search",data:{access_token:e,address:t}}).success(function(t){t=JSON.parse(t),s&&s(t)}).error(function(t){console.log("Address error : "+t.responseJSON.message)})})},mts.address.calculate=function(t,s){mts.auth.connect(function(e){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/address/calculate",data:{access_token:e,addresses:t}}).success(function(t){mts.run.duration=t.time,mts.run.kms=t.distance,s&&s(t)}).error(function(t){console.log("Calculate error : "+t.responseJSON.message)})})},mts.user={},mts.user.get=function(t,s){mts.auth.connect(function(e){$.ajax({method:"GET",url:mts.auth.addr+"/plugin/user",data:{access_token:e,email:t}}).success(function(t){mts.run.owner=t,s&&s(t)}).error(function(t){console.log("User error : "+t.responseJSON.message)})})},mts.form={},mts.form.generate=function(t,s){mts.hasForm||(0==mts.stuff.data.length?mts.stuff.list(function(e){getForm($("#"+t),s)}):getForm($("#"+t),s),mts.hasForm=!0)},mts.run.updateTTC=function(t){var s=0;switch(mts.run.flatRate){case"0":s=parseFloat(mts.run.priceTT)+parseFloat(mts.run.supplement);break;case"1":s=parseFloat(mts.run.pricePP1)+parseFloat(mts.run.supplement);break;case"2":s=parseFloat(mts.run.pricePP2)+parseFloat(mts.run.supplement)}s=s.toFixed(2),t.val(s+"€")},mts.stuff.getForSelect=function(t,s){var e=[];for(var n in t)if(s){var r=0;for(var u in t[n].depositStep)r+=t[n].depositStep[u].nb;var o=t[n].nb-r;o>0&&e.push({id:t[n].id,text:o+" "+t[n].name})}else e.push({id:t[n].id,text:t[n].name});return e},mts.stuff.getNotDeposit=function(t){stuffs=[];for(var s in t)if(t[s].depositStep.length<=0)stuffs.push(t[s]);else{var e=0;for(var n in t[s].depositStep)e+=t[s].depositStep[n].nb;t[s].nb>e&&stuffs.push(t[s])}return stuffs},mts.stuff.getIndexStuffFromId=function(t){for(var s in mts.stuff.data)if(mts.stuff.data[s].id==t)return s},mts.stuff.getIndexStuffFromIdOfRunStuffs=function(t){for(var s in mts.run.stuffs)if(mts.run.stuffs[s].id==t)return s};